@using EmmasEngines.ViewModels
<link rel="stylesheet" href="~/css/styles.css" asp-append-version="true" />
<script src="https://kit.fontawesome.com/f8c88d6b79.js" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.3/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
@model EmmasEngines.ViewModels.ReportsVM
@{
    ViewBag.Title = "Reports";
}
<style>
    li a {
        color: black;
    }
</style>
<main>
    <section id="pageName">
        <h1>REPORTS</h1>
    </section>

    <!-- Tab-based layout -->
    <ul class="nav nav-tabs" id="reportTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="sales-tab" data-toggle="tab" href="#salesTab" role="tab" aria-controls="salesTab" aria-selected="true">Sales</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="cogs-tab" data-toggle="tab" href="#cogsTab" role="tab" aria-controls="cogsTab" aria-selected="false">COGS</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="hourly-tab" data-toggle="tab" href="#hourlyTab" role="tab" aria-controls="hourlyTab" aria-selected="false">Hourly</a>
        </li>
    </ul>


    <!-- Tab content -->
    <div class="tab-content" id="reportTabContent">
        <!-- Sales Reports Tab -->
        <div class="tab-pane fade show active" id="salesTab" role="tabpanel" aria-labelledby="sales-tab">
            <form id="createSalesReportForm">
                <div class="form-horizontal">

                    <section id="reportCreationFields">
                        <h2>Create a New Sales Report</h2>

                        <div class="form-group">
                            <label for="reportName">Report Name:</label>
                            <input type="text" class="form-control" id="reportName" name="reportName" required>
                        </div>

                        <div class="form-group">
                            <label for="employee">Employee:</label>
                            <select class="form-control" id="employee" name="employee">
                                <option value="">All Employees</option>
                                @foreach (var employee in Model.SalesReportVM.Employees)
                                {
                                    <option value="@employee.ID">@employee.FirstName @employee.LastName</option>
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" required>
                        </div>

                        <div class="form-group">
                            <label for="endDate">End Date:</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" required>
                        </div>
                    </section>

                    <section id="reportSearch">

                        <div class="btn">
                            <button type="submit" class="btn_crud_add">
                                <i class="fa-solid fa-print"></i> Save
                            </button>
                        </div>

                        <h2><label id="searchHeader" class="control-label">Search Reports: </label></h2>
                    </section>


                </div>
            </form>



            <div id="salesReportsMain">
                <div class="divider2_desc_btn">
                    <div class="description" id="view-all">
                        <!-- Display the saved reports table here -->
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Report Name</th>
                                    <th>Date Start</th>
                                    <th>Date End</th>
                                    <th>Employee</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="savedReportsTable">
                                @if (Model.SalesReportVM.SavedSalesReports == null || !Model.SalesReportVM.SavedSalesReports.Any())
                                {
                                    <tr>
                                        <td colspan="5">No saved reports</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var report in Model.SalesReportVM.SavedSalesReports)
                                    {
                                        <tr>
                                            <td>@report.Description</td>
                                            <td>@report.DateStart.ToShortDateString()</td>
                                            <td>@report.DateEnd.ToShortDateString()</td>
                                            <td>@report.Criteria</td>
                                            <td>
                                                <a asp-controller="Reports" asp-action="GenerateSalesReportPDF" asp-route-id="@report.ID" class="btn btn-primary">Save as PDF</a>
                                                <a asp-controller="Reports" asp-action="Delete" asp-route-id="@report.ID" class="btn btn-danger">Remove</a>
                                            </td>
                                        </tr>
                                    }
                                }

                            </tbody>
                        </table>

                        <div class="d-flex justify-content-center">
                            <nav aria-label="Page navigation">
                                <ul class="pagination">
                                    <li class="page-item @(Model.PageIndex == 1 ? "disabled" : "")">
                                        <a class="page-link" href="/Reports?page=@(Model.PageIndex - 1)">Previous</a>
                                    </li>
                                    @for (int i = 1; i <= Model.TotalPages; i++)
                                    {
                                        <li class="page-item @(Model.PageIndex == i ? "active" : "")"><a class="page-link" href="/Reports?page=@i">@i</a></li>
                                    }
                                    <li class="page-item @(Model.PageIndex == Model.TotalPages ? "disabled" : "")">
                                        <a class="page-link" href="/Reports?page=@(Model.PageIndex + 1)">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>

                    </div>
                </div>
            </div>
        </div>


        <!-- COGS Reports Tab -->
        <div class="tab-pane fade" id="cogsTab" role="tabpanel" aria-labelledby="cogs-tab">
            <h2>COGS Reports</h2>
            <form id="createCogsReportForm">
                <!-- similar form fields as in Sales Reports Tab -->
            </form>
            <div id="cogsReportsTable">
                <!-- similar table structure as in Sales Reports Tab -->
            </div>
        </div>

        <!-- Hourly Reports Tab -->
        <div class="tab-pane fade" id="hourlyTab" role="tabpanel" aria-labelledby="hourly-tab">
            <form id="createHourlyReportForm">
                <!-- similar form fields as in Sales Reports Tab -->
                <div class="form-horizontal">

                    <section id="reportCreationFields">
                        <h2>Create a New Hourly Report</h2>

                        <div class="form-group">
                            <label for="reportName">Report Name:</label>
                            <input type="text" class="form-control" id="reportName" name="reportName" required>
                        </div>

                        <div class="form-group">
                            <label for="employee">Employee:</label>
                            <select class="form-control" id="employee" name="employee">
                                <option value="">All Employees</option>
                                @foreach (var employee in Model.HourlyReportVM.Employees)
                                {
                                    <option value="@employee.ID">@employee.FirstName @employee.LastName</option>
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" required>
                        </div>

                        <div class="form-group">
                            <label for="endDate">End Date:</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" required>
                        </div>
                    </section>

                    <section id="reportSearch">

                        <div class="btn">
                            <button type="submit" class="btn_crud_add">
                                <i class="fa-solid fa-print"></i> Save
                            </button>
                        </div>

                        <h2><label id="searchHeader" class="control-label">Search Reports: </label></h2>
                    </section>


                </div>
            </form>
            <div id="hourlyReportsTable">
                <!-- similar table structure as in Sales Reports Tab -->
                <div class="divider2_desc_btn">
                    <div class="description" id="view-all">
                        <!-- Display the saved reports table here -->
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Report Name</th>
                                    <th>Date Start</th>
                                    <th>Date End</th>
                                    <th>Employee</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="savedHourlyReportsTable">
                                @if (Model.HourlyReportVM.SavedHourlyReports == null || !Model.HourlyReportVM.SavedHourlyReports.Any())
                                {
                                    <tr>
                                        <td colspan="5">No saved reports</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var report in Model.HourlyReportVM.SavedHourlyReports)
                                    {
                                        <tr>
                                            <td>@report.Description</td>
                                            <td>@report.DateStart.ToShortDateString()</td>
                                            <td>@report.DateEnd.ToShortDateString()</td>
                                            <td>@report.Criteria</td>
                                            <td>
                                                <a class="btn btn-primary">Save as PDF</a>
                                                <a asp-controller="Reports" asp-action="Delete" asp-route-id="@report.ID" class="btn btn-danger">Remove</a>
                                            </td>
                                        </tr>
                                    }
                                }

                            </tbody>
                        </table>

                        <div class="d-flex justify-content-center">
                            <nav aria-label="Page navigation">
                                <ul class="pagination">
                                    <li class="page-item @(Model.PageIndex == 1 ? "disabled" : "")">
                                        <a class="page-link" href="/Reports?page=@(Model.PageIndex - 1)">Previous</a>
                                    </li>
                                    @for (int i = 1; i <= Model.TotalPages; i++)
                                    {
                                        <li class="page-item @(Model.PageIndex == i ? "active" : "")"><a class="page-link" href="/Reports?page=@i">@i</a></li>
                                    }
                                    <li class="page-item @(Model.PageIndex == Model.TotalPages ? "disabled" : "")">
                                        <a class="page-link" href="/Reports?page=@(Model.PageIndex + 1)">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    $(document).ready(function () {
        // Initialize the tabs
        $("#reportTabs a").click(function (e) {
            e.preventDefault();
            $(this).tab('show');
        });
    });


    // Handle the form submission
    $("#createSalesReportForm").submit(function (event) {
        event.preventDefault();

        // Serialize the form data
        let formData = $(this).serialize();

        // Make the AJAX request
        $.post("/Reports/CreateSaleReport", formData, function (data) {
            // Handle the response (e.g., update the saved reports table)
            if (data.success) {
                alert("report saved");
                var report = data.report;
                console.log("Report Object: " + JSON.stringify(report));
                //Get report name from input field
                var reportName = $("#reportName").val();


                // Construct row to add to the table
                var row = '<tr>' +
                    '<td>' + reportName + '</td>' +
                    '<td>' + report.dateStart + '</td>' +
                    '<td>' + report.dateEnd + '</td>' +
                    '<td>' + report.criteria + '</td>' +
                    '<td>' +
                    '<a asp-controller="Reports" asp-action="View" asp-route-id="' + report.id + '" class="btn btn-primary">View</a> ' +
                    '<a asp-controller="Reports" asp-action="Delete" asp-route-id="' + report.id + '" class="btn btn-danger">Remove</a>' +
                    '</td>' +
                    '</tr>';
                // Append row to table
                $('#savedReportsTable').append(row);
            } else {
                // Display an error message
                alert("Error: " + data.message);
            }
        });
    });

    // Handle the form submission - Hourly report
    $("#createHourlyReportForm").submit(function (event) {
        event.preventDefault();

        // Serialize the form data
        let formData = $(this).serialize();

        //alert(formData);

        // Make the AJAX request
        $.post("/Reports/CreateHourlyReport", formData, function (data) {
            // Handle the response (e.g., update the saved reports table)
            if (data.success) {
                alert("report saved");
                var report = data.report;
                console.log("Report Object: " + JSON.stringify(report));
                //Get report name from input field
                //var reportName = $("#hourlyReportName").val();

                //alert(JSON.stringify(report));


                // Construct row to add to the table
                var row = '<tr>' +
                    '<td>' + report.description + '</td>' +
                    '<td>' + report.dateStart + '</td>' +
                    '<td>' + report.dateEnd + '</td>' +
                    '<td>' + report.criteria + '</td>' +
                    '<td>' +
                    '<a asp-controller="Reports" asp-action="View" asp-route-id="' + report.id + '" class="btn btn-primary">View</a> ' +
                    '<a asp-controller="Reports" asp-action="Delete" asp-route-id="' + report.id + '" class="btn btn-danger">Remove</a>' +
                    '</td>' +
                    '</tr>';
                // Append row to table
                $('#savedHourlyReportsTable').append(row);
            } else {
                // Display an error message
                alert("Error: " + data.message);
            }
        });
    });

    // Handle the Save & Print button
    $("#saveAndPrint").click(function () {
        // TODO: Implement the Save & Print functionality
    });
</script>

